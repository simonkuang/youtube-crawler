; YouTube爆款视频采集工具 - Supervisord 配置文件
; 用于生产环境进程管理和监控

[unix_http_server]
file=%(here)s/pids/supervisor.sock
chmod=0700

[supervisord]
logfile=%(here)s/logs/supervisord.log
logfile_maxbytes=50MB
logfile_backups=10
loglevel=info
pidfile=%(here)s/pids/supervisord.pid
nodaemon=false
minfds=1024
minprocs=200
user=%(ENV_USER)s

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix://%(here)s/pids/supervisor.sock

; ============================================================
; YouTube Scrawler 后端服务
; ============================================================
[program:youtube-scrawler-server]
command=node %(here)s/server/dist/index.js
directory=%(here)s/server
user=%(ENV_USER)s
autostart=true
autorestart=true
startretries=3
startsecs=10
stopwaitsecs=10
stopasgroup=true
killasgroup=true

; 环境变量
environment=NODE_ENV="production",PORT="3001"

; 标准输出日志
stdout_logfile=%(here)s/logs/server.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stdout_capture_maxbytes=1MB

; 错误输出日志
stderr_logfile=%(here)s/logs/server-error.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=10
stderr_capture_maxbytes=1MB

; 进程���先级
priority=999

; ============================================================
; 日志清理任务（每天凌晨3点清理30天前的日志）
; ============================================================
[program:log-cleaner]
command=bash -c 'while true; do find %(here)s/logs -name "*.log.*" -mtime +30 -delete; sleep 86400; done'
directory=%(here)s
user=%(ENV_USER)s
autostart=true
autorestart=true
startsecs=0
stdout_logfile=/dev/null
stderr_logfile=/dev/null
priority=1

; ============================================================
; 健康检查任务（每5分钟检查一次）
; ============================================================
[program:health-checker]
command=bash %(here)s/scripts/health-check.sh
directory=%(here)s
user=%(ENV_USER)s
autostart=true
autorestart=true
startsecs=0
stdout_logfile=%(here)s/logs/health-check.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3
stderr_logfile=%(here)s/logs/health-check-error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=3
priority=100

; ============================================================
; 进程组配置
; ============================================================
[group:youtube-scrawler]
programs=youtube-scrawler-server
priority=999
